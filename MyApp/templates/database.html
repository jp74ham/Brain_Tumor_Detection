<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Database Query Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/globals.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styleguide.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/database.css') }}" />
  </head>
  <body>
    <div class="database-container">
      <header class="database-header">
        <h1>Database Query Interface</h1>
        <div class="header-actions">
          <span class="username">Logged in as: admin</span>
          <a href="/logout" class="logout-btn">Logout</a>
        </div>
      </header>

      <main class="database-main">
        <div class="query-section">
          <h2>Execute SQL Query</h2>
          <p class="info-text">Only SELECT queries are allowed for security.</p>
          
          <div class="query-input-container">
            <textarea id="query-input" placeholder="Enter your SQL query here...
Example:
SELECT * FROM mri_scans LIMIT 10;"></textarea>
            <button id="execute-btn" class="execute-btn">Execute Query</button>
          </div>

          <div class="sample-queries">
            <h3>Sample Queries:</h3>
            <button class="sample-query-btn" data-query="SELECT label AS tumor_type, COUNT(*) AS total_cases FROM mri_scans GROUP BY label ORDER BY total_cases DESC;">Total cases by tumor type</button>
            <button class="sample-query-btn" data-query="SELECT CASE WHEN age BETWEEN 20 AND 29 THEN '20s' WHEN age BETWEEN 30 AND 39 THEN '30s' WHEN age BETWEEN 40 AND 49 THEN '40s' WHEN age BETWEEN 50 AND 59 THEN '50s' WHEN age BETWEEN 60 AND 69 THEN '60s' ELSE '70s+' END AS age_group, label, AVG(orig_width * orig_height) AS avg_area, COUNT(*) AS cases FROM mri_scans GROUP BY age_group, label ORDER BY age_group;">Age groups and average image area</button>
            <button class="sample-query-btn" data-query="SELECT hospital_unit, label AS tumor_type, COUNT(*) AS cases FROM mri_scans GROUP BY hospital_unit, label ORDER BY hospital_unit, cases DESC;">Cases by hospital unit</button>
            <button class="sample-query-btn" data-query="SELECT gender, label AS tumor_type, COUNT(*) AS total FROM mri_scans GROUP BY gender, tumor_type ORDER BY gender;">Gender distribution by tumor type</button>
            <button class="sample-query-btn" data-query="SELECT processed_path, age, gender, hospital_unit FROM mri_scans WHERE label = 'glioma_tumor' AND age > 50 LIMIT 100;">Glioma cases (age &gt; 50)</button>
            <button class="sample-query-btn" data-query="SELECT STRFTIME('%Y-%W', scan_date) AS week, label AS tumor_type, COUNT(*) AS cases FROM mri_scans GROUP BY week, tumor_type ORDER BY week;">Weekly case trends</button>
            <!-- removed old prompt-based "Find scans by Patient ID" button -->
            <!-- Last three buttons removed per user request -->
          </div>

          <div class="find-patient-panel" style="margin-top:16px;">
            <label for="find-patient-id" class="text-wrapper-2">Search / Delete MRI scans by Patient ID</label>
            <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
              <input id="find-patient-id" type="text" placeholder="Enter patient ID" style="padding:8px; font-size:14px;" />
              <button id="find-patient-submit" class="sample-query-btn">Search</button>
              <button id="find-patient-delete" class="sample-query-btn" style="background:#c94a4a; color:#fff;">Delete Scans</button>
            </div>
            <div style="margin-top:8px; font-size:12px; color:#666;">Delete will remove scans (and related classifications) for the provided Patient ID. Admins only. This action is irreversible.</div>
          </div>
        </div>

        <div class="results-section">
          <h2>Query Results</h2>
          <div id="results-container">
            <p class="no-results">No query executed yet. Enter a query above and click "Execute Query".</p>
          </div>
        </div>
      </main>

      <section class="patient-section">
        <h2>Add Patient and MRI Scan</h2>
        <p class="info-text">Create a new patient record and upload an MRI scan. After saving, you can run the trained model to populate predicted attributes.</p>
        <form id="patient-form" enctype="multipart/form-data">
          <div class="form-row">
            <label for="patient-age">Age</label>
            <input type="number" id="patient-age" name="age" min="0" max="120" required />
          </div>
          <div class="form-row">
            <label for="patient-gender">Gender</label>
            <select id="patient-gender" name="gender">
              <option value="unknown">Prefer not to say</option>
              <option value="female">Female</option>
              <option value="male">Male</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-row">
            <label for="patient-hospital">Hospital / Unit</label>
            <input type="text" id="patient-hospital" name="hospital_unit" />
          </div>
          <div class="form-row">
            <label for="mri-file">MRI Image</label>
            <input type="file" id="mri-file" name="mri_file" accept="image/*" required />
          </div>
          <div class="form-row">
            <button type="button" id="submit-patient-btn" class="primary-button">Save Patient + Upload Scan</button>
          </div>
        </form>

        <div id="patient-response" aria-live="polite"></div>
      </section>
    </div>

    <script src="{{ url_for('static', filename='css/database.js') }}"></script>
  </body>
</html>
